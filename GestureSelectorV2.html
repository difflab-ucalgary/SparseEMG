<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SparseEMG</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="js/libs/snap.svg.js"></script>
    <script src="js/sparseEMGClasses/Renderer.js"></script>

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Custom Styles -->
    <style>
      .main-card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        transition: transform 0.2s;
        min-height: 865px;
      }

      .main-card:hover {
        transform: translateY(-2px);
      }

      .gesture-img {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        border-radius: 8px;
      }

      .gesture-img.selected {
        border-color: #0d6efd;
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.4);
      }

      .canvas-container {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        background: white;
      }

      .control-header {
        font-weight: 600;
        color: #2c3e50;
      }

      .generate-btn {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .generate-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
      }
      .inline-icon {
        vertical-align: bottom;
      }
    </style>

    <style>
      .electrode-point {
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .electrode-point.selected {
        fill: #4caf50 !important;
        stroke: #2e7d32 !important;
        filter: drop-shadow(0 0 2px rgba(76, 175, 80, 0.5));
      }
      body {
        background-color: #f8f9fa;
      }
      .heatmap-table {
        border-collapse: collapse;
      }
      .heatmap-table td,
      .heatmap-table th {
        width: 60px;
        height: 60px;
        text-align: center;
        vertical-align: middle;
        border: 1px solid #dee2e6;
        font-weight: bold;
        font-family: "Segoe UI", sans-serif;
        font-size: 12px; /* smaller font */
        padding: 0;
      }
      .heatmap-table th {
        background-color: #e9ecef;
        color: #212529;
      }
    </style>

    <!-- Previous CSS links and scripts remain the same -->
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <img
            src="icons/tool_icon_v1.png"
            alt="Logo"
            height="40"
            class="me-2"
          />
          <span class="h4 mb-0">SparseEMG</span>
        </a>
      </div>
    </nav>

    <div class="container mb-4">
      <div class="row g-4 d-flex align-items-stretch">
        <!-- Left Control Panel -->
        <div class="col-lg-3 px-0">
          <div class="card main-card">
            <div class="card-body">
              <h5 class="control-header mb-3">
                <span class="inline-icon material-icons-outlined">folder</span>
                Dataset Selection
              </h5>
              <div class="mb-3">
                <label class="form-label">Select Dataset</label>
                <select class="form-select" id="datasetSelect">
                  <option value="">Choose dataset...</option>
                  <option value="CSL-HDEMG">CSL-HDEMG</option>
                  <option value="PutEMG">PutEMG</option>
                  <option value="Nizamis et al.">Nizamis et al.</option>
                  <option value="DELTA">DELTA</option>
                  <option value="GrabMyo">GrabMyo</option>
                  <option value="Hyser">Hyser</option>
                </select>
              </div>

              <div class="mb-3">
                <h5 class="control-header">
                  <span class="inline-icon material-icons-outlined">info</span>
                  Dataset Details
                </h5>
                <div class="list-group list-group-flush">
                  <div class="list-group-item">
                    Name: <span id="dataset_name" class="fw-medium">-</span>
                  </div>
                  <div class="list-group-item">
                    Electrodes: <span id="dataset_electrodes">-</span>
                  </div>
                  <div class="list-group-item">
                    Number of Gestures:
                    <span id="dataset_gestures_info">-</span>
                  </div>
                  <div class="list-group-item">
                    Year: <span id="dataset_year">-</span>
                  </div>
                  <div class="list-group-item">
                    Publication Venue: <span id="dataset_publication">-</span>
                  </div>
                </div>
              </div>

              <!-- Model Parameters -->
              <div class="mt-4">
                <h5 class="control-header mb-3">
                  <span class="inline-icon material-icons-outlined"
                    >settings</span
                  >
                  Model Parameters
                </h5>

                <div class="mb-3">
                  <label class="form-label">Metric</label>
                  <select class="form-select" id="metricSelect">
                    <option value="permutation_importance">
                      Permutation Importance
                    </option>
                    <option value="mutual_importance">Mutual Importance</option>
                    <option value="rms">RMS-Based Importance</option>
                    <option value="SHAP">
                      SHAP
                    </option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Classifier</label>
                  <select class="form-select" id="classifierSelect">
                    <option value="random_forest">Random Forest</option>
                    <option value="logistic_regression">
                      Logistic Regression
                    </option>
                    <option value="support_vector_classifier">Support Vector Classifier</option>
                    <option value="xgboost">XGBoost</option>
                    <option value="k_nearest_neighbors">K-Nearest Neigbors</option>
                    <option value="naive_bayes">Naive Bayes</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="electrode_channel_slider"
                    >Channel Limit: <span id="channel_limit">0</span></label
                  >
                  <input
                    class="form-range"
                    type="range"
                    id="electrode_channel_slider"
                    name="channel_limit"
                    min="0"
                    max="100"
                    step="1"
                    value="0"
                    oninput="channel_limit.innerText = this.value"
                  />
                </div>

                <div class="mb-3">
                  <!-- <div class="form-check form-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="sketch_toggle"
                      onchange="sketch_toggle = this.checked"
                    />
                    <label class="form-check-label" for="sketch_toggle"
                      >Enable Sketching</label
                    >
                  </div> -->
                  <div class="form-check form-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="optimize_toggle"
                      onchange="optimize_toggle = this.checked"
                    />
                    <label class="form-check-label" for="optimize_toggle"
                      >Enable Optimization</label
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Canvas -->
        <div class="col-lg-6">
          <div class="card main-card">
            <div class="card-body">
              <h5 class="control-header mb-3">Visualization Canvas</h5>
              <div id="electrode-tooltip" class="d-none">
                <div>Click electrodes to select</div>
              </div>
              <div class="canvas-container position-relative">
                <svg
                  id="drawing"
                  class="img-fluid"
                  viewBox="0 0 350 400"
                  style="background-color: #f8f9fa; border-radius: 8px"
                >
                  <!-- Grid will be rendered here -->
                </svg>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Gesture Selection -->
        <div class="col-lg-3 px-0">
          <div class="card main-card">
            <div class="card-body pb-0">
              <h5 class="control-header mb-3">
                <span class="inline-icon material-icons-outlined"
                  >waving_hand</span
                >
                Gesture Selection
              </h5>
              <div
                id="gesture-container"
                class="row row-cols-1 g-2"
                style="height: 330px; overflow-y: auto"
              ></div>
            </div>
            <div id="confusion-matrix-card">
              <table class="heatmap-table" id="confusion-matrix"></table>
              <div class="card-body">
                <h5 class="card-title text-center" id="predicted_accuracy">
                </h5>
              </div>
            </div>
            <div class="card-footer d-flex justify-content-between gap-2">
              <button
                class="btn generate-btn flex-fill"
                onclick="getUserSelectedData()"
              >
                Generate layout
              </button>
              <button class="btn generate-btn flex-fill" data-bs-toggle="modal" data-bs-target="#imageModal">
                Generate stencil
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-body text-center">

              <!-- Page 1: Circumference Inputs -->
              <div id="page1">
                <h5>Enter Circumference Values</h5>
                <p id="instructionText" style="text-align: left;">
                  Enter 8 comma separate circumference values starting from 20% of your forearm length from the elbow.
                </p>
                <div class="row">
                  <div class="col mb-2"><input class="form-control" placeholder="Circumference Values" /></div>
                </div>
                <button class="btn generate-btn mt-3" onclick="goToPage2()">Next</button>
              </div>

              <!-- Loader -->
              <div id="loader" style="display: none;">
                <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>

              <!-- Page 2: Image and Download -->
              <div id="page2" style="display: none;">
                <div id="mainImageContainer" class="text-center"></div>
                <div class="mb-3">
                  <a href="./server/static/ellipse_grid_variable_spacing.svg" download class="btn generate-btn flex-fill">
                    Download Stencil Image
                  </a>
                  <button class="btn generate-btn" onclick="goBackToPage1()">Back</button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    <script>
      var MAIN_CANVAS_SVG_WIDTH = 400;
      var MAIN_CANVAS_SVG_HEIGHT = 400;
      var EMG_ELECTRODE_SIZE = 2.5;

      var sketch_toggle = false;
      var optimize_toggle = false;
      var emg_dataset;

      // Initialize main canvas
      let main_canvas = Snap("#drawing");
      let electrodeSet = [];
      let dataset_gestures = [];

      function goToPage2() {
        document.getElementById('page1').style.display = 'none';
        document.getElementById('loader').style.display = 'block';

        var payload = {
          ds: document.getElementById('datasetSelect').value,
          circumference_values: document.querySelector('input.form-control').value.split(',').map(Number),
          selected_electrodes: electrodeSet.filter(e => e.selected).map(e => e.id),
        };

        axios.post('http://127.0.0.1:8000/generate_stencil', payload).then(response => {
          mainImageContainer = document.getElementById('mainImageContainer');
          mainImageContainer.innerHTML = ''; // Clear previous content
          mainImageContainer.innerHTML =
            `<img src="./server/static/ellipse_grid_variable_spacing.svg" alt="Large Preview" class="img-fluid mb-4" />`
        }).catch(error => {
          console.error(error);
        });

        setTimeout(() => {
          document.getElementById('loader').style.display = 'none';
          document.getElementById('page2').style.display = 'block';
        }, 500);
      }

      function goBackToPage1() {
        document.getElementById('page2').style.display = 'none';
        // document.getElementById('loader').style.display = 'block';
        document.getElementById('page1').style.display = 'block';

        setTimeout(() => {
          // document.getElementById('loader').style.display = 'none';
          document.getElementById('page1').style.display = 'block';
        }, 500);
      }

      document
        .getElementById("datasetSelect")
        .addEventListener("change", function () {
          const selectedDataset = this.value;
          if (selectedDataset === "CSL-HDEMG") {
            loadDataset("./datasets/CSL-HDEMG/dataset_metadata.json");
          } else if (selectedDataset === "PutEMG") {
            loadDataset("./datasets/putEMG/dataset_metadata_putemg.json");
          }  else if (selectedDataset === "Nizamis et al.") {
            loadDataset("./datasets/Nizamis et al/dataset_metadata_nizamis.json");
          } else if (selectedDataset === "Hyser") {
            loadDataset("./datasets/Hyser/dataset_metadata_hyser.json");
          } else if (selectedDataset === "DELTA") {
            loadDataset("./datasets/DELTA/dataset_metadata_delta.json");
          } else if (selectedDataset === "GrabMyo") {
            loadDataset("./datasets/GrabMyo/dataset_metadata_grabmyo.json");
          }
          else if (selectedDataset === "") {
            resetDatasetDetails();
          }
          resetConfusionMatrix();
        });

      function renderDatasetDetails(data) {
        dataset_name.innerHTML = data.dataset_name;
        dataset_electrodes.innerHTML = data.number_of_electrodes;
        dataset_gestures_info.innerHTML = data.number_of_gestures;
        dataset_year.innerHTML = data.year;
        dataset_publication.innerHTML = data.publication_venue_short;
        instructionText.innerText = `Enter ${data.number_of_rows} comma separate circumference values starting from 20% of your forearm length from the elbow.`;
      }

      function resetDatasetDetails() {
        dataset_name.innerHTML = "-";
        dataset_electrodes.innerHTML = "-";
        dataset_gestures_info.innerHTML = "-";
        dataset_year.innerHTML = "-";
        dataset_publication.innerHTML = "-";
        main_canvas.clear();
        const container = document.getElementById("gesture-container");
        container.innerHTML = "";
      }

      // Modified loadDataset function
      function loadDataset(jsonFile) {
        fetch(jsonFile)
          .then((response) => response.json())
          .then((data) => {
            // Clear previous data
            dataset_gestures = [];
            main_canvas.clear();
            Renderer.RenderGridWithLines(main_canvas);

            // Update dataset info
            renderDatasetDetails(data);
            renderGestureImages(data);
            renderDatasetElectrodes(data);

            const electrode_tooltip = document.getElementById("electrode-tooltip");
            electrode_tooltip.classList.remove("d-none");

            const slider = document.getElementById("electrode_channel_slider");
            slider.max = data.number_of_electrodes;
          });
      }

      function renderGestureImages(data) {
        const container = document.getElementById("gesture-container");
        container.innerHTML = "";

        data.gesture_classes.forEach((gestureClass) => {
          const classHtml = `
          <div class="col-12 mb-4">
            <h6 class="text-primary mb-3">${gestureClass.class_name}</h6>
            <div class="row g-2">
              ${gestureClass.gestures
                .map((gesture) => {
                  dataset_gestures.push({
                    gesture_name: gesture.gesture_name,
                    id: gesture.id,
                    selected: false,
                  });
                  return `
                <div class="col-4 col-md-3">
                  <div class="gesture-img-wrapper text-center">
                    <img src="${gesture.illustration}"
                         style="max-height: 80px; min-height: 80px; object-fit: cover;"
                         class="gesture-img img-fluid rounded"
                         data-gesture="${gesture.gesture_name}"
                         title="${gesture.gesture_name}">
                    <small class="text-muted d-block mt-1">${gesture.gesture_name}</small>
                  </div>
                </div>
              `;
                })
                .join("")}
            </div>
          </div>
        `;
          container.insertAdjacentHTML("beforeend", classHtml);
        });

        // Add click handlers
        container.querySelectorAll(".gesture-img").forEach((img) => {
          img.addEventListener("click", function () {
            this.classList.toggle("selected");
            const gestureName = this.dataset.gesture;
            const index = dataset_gestures.findIndex(
              (g) => g.gesture_name === gestureName
            );
            if (index !== -1) {
              dataset_gestures[index].selected =
                !dataset_gestures[index].selected;
            }
          });
        });
      }

      // Electrode rendering function
      function renderDatasetElectrodes(data) {
        Snap.load(data.electrode_placement_illustration, function (fragment) {
          main_canvas.append(fragment);

          main_canvas.selectAll("*[id]").forEach((element) => {
            const elementId = Number(element.attr("id").split("_")[1]);
            element.addClass("electrode-point");

            element.click(function () {
              const currentElectrode = electrodeSet.find(
                (e) => e.id === elementId
              );
              if (!currentElectrode) {
                console.log(elementId);
                electrodeSet.push({ id: elementId, selected: true });
                element.addClass("selected");
                element.attr({ fill: "#4CAF50", stroke: "#2E7D32" });
              } else {
                currentElectrode.selected = !currentElectrode.selected;
                element.toggleClass("selected");
                element.attr({
                  fill: currentElectrode.selected ? "#4CAF50" : "#000",
                  stroke: currentElectrode.selected ? "#2E7D32" : "#000",
                });
              }
            });
          });
        });
      }

      function getUserSelectedData() {
        var selectedGestures = [];
        var selectedElectrodes = [];

        dataset_gestures.forEach((g) => {
          if (g.selected) {
            selectedGestures.push(g.id);
          }
        });

        electrodeSet.forEach((e) => {
          if (e.selected) {
            selectedElectrodes.push(e.id);
          }
        });

        // const numChannels = num_selected_channels;
        var numChannels = parseInt(electrode_channel_slider.value);
        const metric = document.getElementById("metricSelect").value;
        const classifier = document.getElementById("classifierSelect").value;
        const ds = document.getElementById("datasetSelect").value;
        const dataToSend = {
          ds,
          selected_gestures: selectedGestures,
          area_no_of_channels: selectedElectrodes,
          no_of_channels: numChannels,
          metric: metric,
          classifier: classifier,
          optimize_toggle: optimize_toggle,
        };
        // Create or reuse WebSocket connection
        if (!window.ws || window.ws.readyState !== WebSocket.OPEN) {
          window.ws = new WebSocket("ws://127.0.0.1:8000/ws/train_model");

          window.ws.onopen = () => {
            window.ws.send(JSON.stringify(dataToSend));
          };

          window.ws.onmessage = (event) => {
            const response = JSON.parse(event.data);
            var labels = []
            dataset_gestures.forEach(g => {
              if (g.selected || g.id === 0) {
                labels.push(g.gesture_name);
              }
            });
            selectActiveElectrodes(
              response.best_channels
            );
            resetConfusionMatrix();
            renderConfusionMatrix(
              response.accuracy,
              response.cm,
              labels,
            )
          };

          window.ws.onerror = (err) => {
            console.error("WebSocket error:", err);
          };
        } else {
          window.ws.send(JSON.stringify(dataToSend));
        }
      }

      function getHeatmapColor(val, maxVal) {
        const t = val / maxVal;
        const r = Math.round(8 + (255 - 8) * (1 - t));
        const g = Math.round(48 + (255 - 48) * (1 - t));
        const b = Math.round(107 + (255 - 107) * (1 - t));
        return `rgb(${r}, ${g}, ${b})`;
      }

      function getTextColor(bgColor) {
        const rgb = bgColor.match(/\d+/g).map(Number);
        const luminance = 0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2];
        return luminance < 140 ? "white" : "black";
      }

      function renderConfusionMatrix(accuracy, matrix, labels) {
        const maxVal = Math.max(...matrix.flat());

        const cm_card = document.getElementById("confusion-matrix-card");
        cm_card.classList.add("card");

        const predicted_accuracy = document.getElementById(
          "predicted_accuracy"
        );
        predicted_accuracy.innerText = `Expected Accuracy: ${accuracy}%`;

        const table = document.getElementById("confusion-matrix");

        // Create header row
        const headerRow = document.createElement("tr");
        const cornerTh = document.createElement("th");
        cornerTh.innerText = "Actual";
        headerRow.appendChild(cornerTh);

        if (!labels.includes("Idle")) {
          labels.unshift("Idle")
        }

        labels.forEach((label) => {
          const th = document.createElement("th");
          th.innerText = label;
          headerRow.appendChild(th);
        });

        table.appendChild(headerRow);

        // Create rows
        matrix.forEach((row, i) => {
          const tr = document.createElement("tr");

          const rowLabel = document.createElement("th");
          rowLabel.innerText = labels[i];
          tr.appendChild(rowLabel);

          row.forEach((val) => {
            const td = document.createElement("td");
            const bgColor = getHeatmapColor(val, maxVal);
            const textColor = getTextColor(bgColor);

            td.style.backgroundColor = bgColor;
            td.style.color = textColor;
            td.innerText = val;

            tr.appendChild(td);
          });

          table.appendChild(tr);
        });
      }
      function resetConfusionMatrix() {
        const table = document.getElementById("confusion-matrix");
        table.innerHTML = ""; // Clear the table content
        const cm_card = document.getElementById("confusion-matrix-card");
        cm_card.classList.remove("card");
        const predicted_accuracy = document.getElementById(
          "predicted_accuracy"
        );
        predicted_accuracy.innerText = ""; // Clear the accuracy text
      };

      function selectActiveElectrodes(selectedElectrodes) {
        main_canvas.selectAll(".electrode-point").forEach((element) => {
          const elementId = Number(element.attr("id").split("_")[1]);
          const currentElectrode = electrodeSet.find(
            (e) => e.id === elementId
          );
          if (selectedElectrodes.includes(elementId - 1)) {
            element.addClass("selected");
            element.attr({ fill: "#4CAF50", stroke: "#2E7D32" });
            if (!currentElectrode) {
              electrodeSet.push({ id: elementId, selected: true });
            } else {
              currentElectrode.selected = true;
            }
          } else {
            element.removeClass("selected");
            element.attr({ fill: "#000", stroke: "#000" });
            currentElectrode && (currentElectrode.selected = false)
          }
        });
      }
    </script>
  </body>
</html>
