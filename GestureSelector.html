<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EMG Dataset Viewer</title>
  <link rel="shortcut icon" type="image/x-icon" href="icons/title_icon_64x64.png" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400" rel="stylesheet"/>

  <link rel="stylesheet" href="css/material_and_icons.css"/>
  <link rel="stylesheet" href="css/material.indigo-pink.min.css"/>
  <link rel="stylesheet" href="css/bootstrap3.3.7.min.css"/>
  <link rel="stylesheet" href="css/nouislider.css"/>
  <script src="js/libs/snap.svg.js"></script>

  <link rel="stylesheet" href="css/default.css"/>
  <!--<link rel="stylesheet" href="css/style.css"/>-->
  <link rel="stylesheet" href="css/material_design_cards.css"/>
  <link rel="stylesheet" href="css/mdl_expansion_cards.css"/>
  <link rel="stylesheet" href="css/generate_button_styling.css"/>
  <script src="js/libs/nouislider.js"></script>

  <script src="js/sparseEMGClasses/Renderer.js"></script>
  <script src="js/sparseEMGClasses/InputShapeController.js"></script>


  <style>
    body {
      zoom: 0.6;
    }

    .gesture-class {
      margin-bottom: 20px;
    }

    .gesture-class h2 {
      margin-bottom: 10px;
    }
    .gesture-row {
      display: flex;
      flex-wrap: wrap;
    }
    .gesture {
      margin-right: 10px;
      text-align: center;
    }
    .gesture img {
      width: 100px;
      height: 100px;
    }
    .gesture img.selected {
      border-color: blue;
    }
    h2{
      font-family: 'Roboto Condensed';
      color: rgb(64,64,64);
      display: inline;
    }
  </style>

  <script>
    //Plugin for Snap for getting the point coordinates while drawing with a mouse
    Snap.plugin( function( Snap, Element, Paper, global ) {
      Element.prototype.getCursorPoint = function( x, y ) {
        var pt = this.paper.node.createSVGPoint();
        pt.x = x; pt.y = y;
        return pt.matrixTransform( this.paper.node.getScreenCTM().inverse());
      }
    });
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    form {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }

    .selected {
      fill: rgba(0, 255, 0, 0.5); /* Semi-transparent green */
      stroke: green;
      stroke-width: 2;
    }
  </style>

</head>
<body>
<header class="mdl-layout__header mdl-layout__header--waterfall">
  <div class="mdl-layout__header-row">
        <span class="mdl-layout-title">
            <img src="icons/tool_icon_v1.png" style="display: inline-block;" height="60" width="150"> &nbsp;&nbsp;
            <h1 style="font-family: 'Roboto Condensed'; color: #fefefe;  display: inline">SparseEMG</h1>
        </span>
    <div class="mdl-layout-spacer"></div>
    <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable
                  mdl-textfield--floating-label mdl-textfield--align-right">

      <div class="mdl-textfield__expandable-holder">
        <input class="mdl-textfield__input" type="text" name="sample"
               id="waterfall-exp">
      </div>
    </div>
  </div>
</header>

<br/>
<div class="row row-no-gutters">
  <div class="col-sm-3">

    <div class="demo-card-forearm_polygon_control mdl-card mdl-shadow--16dp">
      <h1>Select EMG Dataset</h1>

      <h2><select id="datasetSelect">
        <option value="">Select a dataset</option>
        <option value="none">None</option>
        <option value="CSL-HDEMG">CSL-HDEMG</option>
        <option value="PutEMG">PutEMG</option>
        <option value="Dataset3">Dataset3</option>
        <option value="Dataset4">Dataset4</option>
        <option value="Dataset5">Dataset 5</option>
      </select></h2>
      <br/>
      <div id="dataset-details">
        <h2 id="dataset_name">Dataset: </h2> </br> <br/>
        <h2 id="dataset_electrodes">Electrodes: </h2> </br> <br/>
        <h2 id="dataset_gesture_classes">Gesture Classes: </h2> </br> <br/>
        <h2 id="dataset_gesture_number">Number of Gestures: </h2> </br> <br/>
        <h2 id="dataset_year">Year: </h2> </br> <br/>
        <h2 id="dataset_publication">Publication Venue: </h2> </br> <br/>
      </div>

    </div>
    <br/> <br/>
    <div class="demo-card-forearm_polygon_control mdl-card mdl-shadow--16dp">
      <h1>MODEL PARAMETERS</h1>



      <h2>Select a Metric &nbsp;<select id="metricSelect">
        <option value="permutation_importance">Permutation Importance</option>
        <option value="rms">RMS</option>
        <option value="mutual_importance">Mutual Importance</option>
        <option value="shap">SHAP</option>
      </select></h2>

      <h2>Select a Classifier &nbsp;<select id="slassifierSelect">
        <option value="logistic_regression">Logistic Regression</option>
        <option value="rms">RMS</option>
        <option value="random_forest">Random Forest</option>
        <option value="SVC">Support Vector Machine</option>
        <option value="knn">k-Nearest Neighbour (KNN)</option>
        <option value="naive_bayes">Naive Bayes</option>
      </select></h2>

      <h2>Electrode Channels</h2>
      <br/>
      <div id = "electrode_channel_slider">
      </div>
      <br/>







    </div>


  </div>

  <div class="col-sm-6">
    <svg id="drawing" height="400mm" width="350mm" viewBox="0 0 350 400">
    </svg>

  </div>
  <div class="col-sm-3">

    <div class="demo-card-shape-customization mdl-card mdl-shadow--16dp">
      <br/>
      <br/>

      <div id="gesture-container"></div>
    </div>
    <br/>

    <button class="generate_btn" onclick="getSelectedElectrodes()">Generate </button>
    <br/> <br/>

    <button class="generate_btn">Generate For Shape</button>

    <br/> <br/> <br/>

  </div>
</div>
<script>



</script>
<script>

  var dataset_gestures = new Array();
  var electrodeSet = new Array();

  var MAIN_CANVAS_SVG_WIDTH = 400;
  var MAIN_CANVAS_SVG_HEIGHT = 400;
  var EMG_ELECTRODE_SIZE = 2.5;

  var sketch_toggle = false;
  var emg_dataset;

  main_canvas = document.getElementById("drawing");
  main_canvas = Snap(main_canvas);
  Renderer.RenderGridWithLines(main_canvas);

  var dataset_name = document.getElementById("dataset_name");
  var dataset_electrodes = document.getElementById("dataset_electrodes");
  var dataset_gesture_classes = document.getElementById("dataset_gesture_classes");
  var dataset_gestures_info = document.getElementById("dataset_gesture_number");
  var dataset_year = document.getElementById("dataset_year");
  var dataset_publication = document.getElementById("dataset_publication");

  var num_selected_channels = 0;

  var electrode_channel_slider = document.getElementById('electrode_channel_slider');
  noUiSlider.create(electrode_channel_slider, {
    start: 1,
    connect: 'lower',
    step:1,
    tooltips: [true],
    range: {
      'min': 1,
      'max': 10
    }
  });
  electrode_channel_slider.noUiSlider.on('update', electrode_channel_slider_handler);

  function electrode_channel_slider_handler(values, handle, unencoded, tap, positions){

    num_selected_channels = values[0];
    //console.log(num_selected_channels);

  }


  function resetDatasetDetails(){
    dataset_name.innerHTML = "Dataset:" + " ";
    dataset_electrodes.innerHTML = "Electrodes:" + " ";
    dataset_gesture_classes.innerHTML = "Gesture Classes:" + " ";
    dataset_gestures_info.innerHTML = "Number of Gestures:" + " ";
    dataset_year.innerHTML = "Year:" + " ";
    dataset_publication.innerHTML = "Publication Venue:" + " ";
  }

  document.getElementById('datasetSelect').addEventListener('change', function() {
    const selectedDataset = this.value;
    if (selectedDataset === 'CSL-HDEMG') {
      loadDataset('./datasets/CSL-HDEMG/dataset_metadata.json');
    }else if(selectedDataset === 'PutEMG'){
      loadDataset('./datasets/putEMG/dataset_metadata_putemg.json');
    }
    else if(selectedDataset === "none"){
      resetDatasetDetails();
    }
  });

  function loadDataset(jsonFile) {
    fetch(jsonFile)
      .then(response => response.json())
      .then(data => {
        console.log(data.number_of_gestures);
        renderDatasetDetails(data);
        renderGestureImages(data);
        renderDatasetElectrodes(data);
      });
  }

  function renderDatasetElectrodes(data){

    electrode_placement_area = Snap.load(data.electrode_placement_illustration, function (f){
      main_canvas.append(f);

      var elements = main_canvas.selectAll("[id]");

      elements.forEach(function (el){
        var elementId = el.attr("id");
        console.log(elementId);
        electrodeSet.push({'id': elementId, 'selected': false});

        el.click(function (){
          console.log("Clicked element with ID:", elementId);
          var currentId= electrodeSet.findIndex(electrode => electrode.id === elementId);
          console.log();
          electrodeSet[currentId].selected = !electrodeSet[currentId].selected
         // currentId.selected = !currentId.selected;
         // (electrodeSet.findIndex(electrode => electrode.id === elementId)).selected =  !((electrodeSet.findIndex(electrode => electrode.id === elementId)).selected);

          if(electrodeSet[currentId].selected === true){
            el.attr({fill: '#22ff69'});
          }else{
            el.attr({fill: '#000000'});
          }

        });

        console.log(electrodeSet);
      });

    }, function (error){
      console.error("Failed to load SVG Electrode Illustration: ", error);
    });
  }

  function renderDatasetDetails(data){
    dataset_name.innerHTML = "Dataset: " + data.dataset_name;
    dataset_electrodes.innerHTML = "Electrodes:" + data.number_of_electrodes + "";
    dataset_gesture_classes.innerHTML = "Gesture Classes: " + data.gesture_classes.length;
    dataset_gestures_info.innerHTML = "Number of Gestures: " + data.number_of_gestures;
    dataset_year.innerHTML = "Year: " + data.year + "";
    dataset_publication.innerHTML = "Publication Venue:" + data.publication_venue_short + " ";

  }

  function renderGestureImages(data) {
    main_canvas.clear();
    Renderer.RenderGridWithLines(main_canvas);
    const container = document.getElementById('gesture-container');
    var GESTURES_PER_ROW = 5;

    data.gesture_classes.forEach(gestureClass => {
      var i =0 ;
      const classDiv = document.createElement('div');
      classDiv.className = 'gesture-class';

      const classTitle = document.createElement('h2');
      classTitle.textContent = gestureClass.class_name;
      classDiv.appendChild(classTitle);

      let gestureRow = document.createElement('div');
      gestureRow.className = 'gesture-row';

      gestureClass.gestures.forEach((gesture, index) => {
        if (index > 0 && index % GESTURES_PER_ROW === 0) {
          classDiv.appendChild(gestureRow);
          gestureRow = document.createElement('div');
          gestureRow.className = 'gesture-row';
        }

        const gestureDiv = document.createElement('div');
        gestureDiv.className = 'gesture';

        const gestureImg = document.createElement('img');
        gestureImg.src = gesture.illustration;
        gestureImg.alt = gesture.gesture_name;
        dataset_gestures.push({'gesture_name': gesture.gesture_name, 'selected' : false});
        gestureImg.addEventListener('click', () => {
          console.log("gesture clicked");
          let index = dataset_gestures.findIndex(item => item['gesture_name'] === gesture.gesture_name);
          if(dataset_gestures[index].selected == false){
            gestureImg.style.border = '3px solid green';
            dataset_gestures[index].selected = true;
          }else{
            gestureImg.style.border = '0px solid blue';
            dataset_gestures[index].selected = false;
          }

        });
        gestureDiv.appendChild(gestureImg);

        const gestureName = document.createElement('p');
        gestureName.textContent = gesture.gesture_name;
        gestureDiv.appendChild(gestureName);

        gestureRow.appendChild(gestureDiv);
        i++;
      });

      classDiv.appendChild(gestureRow);
      container.appendChild(classDiv);
      console.log(dataset_gestures);
    });
  }

</script>

<script>


  var mouse_down_state = false;
  var sketchedPointArray = new Array();
  var inputPath = new Array();
  var cursor;
  var inputShapes = new Array();

  var input_shape_enabled = false;

  main_canvas.mousedown(function (ev, x, y) {
    if(sketch_toggle){
      var cpt;
      var point;
      mouse_down_state = true;
      cpt = main_canvas.getCursorPoint(x,y);
      if(cursor == null){
        cursor = main_canvas.circle(cpt.x, cpt.y ,2).attr({ fill: "blue" });
        sketchedPointArray.push(cpt.x, cpt.y);
        inputPath.push([cpt.x, cpt.y]);
      }



    }

  });

  main_canvas.mousemove(function (ev, x, y) {
    var cpt;
    var point;

    if(mouse_down_state ==true){
      cpt = main_canvas.getCursorPoint(x,y);
      sketchedPointArray.push(cpt.x, cpt.y);
      inputPath.push([cpt.x, cpt.y]);
      cursor.attr({cx:cpt.x, cy:cpt.y});
    }


  });

  main_canvas.mouseup(function (ev, x,y) {
    mouse_down_state = false;
    InputShapeController.SetShapeCoords(sketchedPointArray);
    InputShapeController.SetInputShapeType("free-form");
    InputShapeController.RenderInputShape(main_canvas,"free-form");
    inputShapes.push(sketchedPointArray);
    sketchedPointArray = [];
    //InputShapeController.SetShapeInputFields(InputShapeController.GetShapeSVG());

    //console.log(inputShapes);


  });

</script>

<script>
  // Load the SVG file
  Snap.load("./datasets/CSL-HDEMG/electrode_placement.svg", function (loadedFragment) {
    //var svgContainer = Snap("#svg-container");
    main_canvas.append(loadedFragment);

    // Select all circles in the SVG
    var circles = main_canvas.selectAll("circle");

    // Add click event listener to each circle
    circles.forEach(function (circle) {
      circle.click(function () {
        alert("Circle clicked: " + this.attr("id"));
      });
    });
  });
</script>

</body>
</html>
